!function(t){"use strict";function e(){this.events={}}function n(t){this.editor=t}function r(){this.middleware=[]}function i(t){this.id=t,this.modified=!1,this.data={},this.tmp={}}function a(){this.structure=null,this.data={}}function o(){this.figureTypes={},this.registerFigureType("default",{updateData:function(t,e){e.set("html",t.innerHTML)},updateHTML:function(t,e){t.innerHTML=e.get("html")}})}function s(t,e){this.options=e||(e={}),this.name=t}function c(){}function u(t){e.call(this),r.call(this),a.call(this),c.call(this),o.call(this),this.options=p.mixin(Object.create(O),t||{}),this.context={},this.context.editor=this;var i=this.options.el;i||(i=document.createElement("div")),i.setAttribute("contenteditable",!0),i.classList.add("med"),this.el=i,this.caret=new n(this),this.bindEvents(),this.handleEmpty(),this.use(T())}"undefined"!=typeof module?module.exports=u:"function"==typeof define&&"object"==typeof define.amd?define(function(){return u}):t.Med=u;var p={};p.getTextContent=function(t){var e;if(!t)return"";switch(t.nodeType){case document.ELEMENT_NODE:e=t.textContent||t.innerText||"";break;case document.TEXT_NODE:e=t.data;break;default:e=""}return e},p.setNodeContent=function(t,e){p.isTextNode(t)?t.data=e:t.innerHTML=e},p.isEmpty=function(t){return p.isTag("br",t)?!1:!p.getTextContent(t).trim()},p.isNotEmpty=function(t){return!p.isEmpty(t)},p.isTag=function(t,e){if(!e)return!1;"string"==typeof t&&(t=[t]);var n=function(t){return t.toUpperCase()};return!!~t.map(n).indexOf(e.tagName)},p.isAllowedToHaveContent=function(t){return!p.isTag(["br","input","img"],t)},p.isLastChild=function(t){return t.parentELement.lastChild===t},p.removeEmptyElements=function(t){var e=function(t){return p.isType("figure",t)||!p.isAllowedToHaveContent(t)};p.each(t.children,function(n){e(n)||(p.isEmpty(n)?t.removeChild(n):p.removeEmptyElements(n))})},p.removeElement=function(t){t.parentElement&&t.parentElement.removeChild(t)},p.moveChildren=function(t,e){var n=Array.prototype.slice.call(t.children);p.each(n,function(t){e.appendChild(t)})},p.moveChildNodes=function(t,e){var n=Array.prototype.slice.call(t.childNodes);p.each(n,function(t){e.appendChild(t)})},p.isType=function(t,e){var n=p.getElementSchema(e);return"string"==typeof t&&(t=[t]),n&&!!~t.indexOf(n.type)},p.isElementNode=function(t){return t&&t.nodeType===document.ELEMENT_NODE},p.isTextNode=function(t){return t&&t.nodeType===document.TEXT_NODE},p.isAncestorOf=function(t,e){var n=p.getParents(t);return!!~n.indexOf(e)},p.getParents=function(t){var e,n=[];if(!t)return n;for(;e=t.parentNode;)n.push(e),t=e;return n},p.nodeContentLength=function(t){return p.getTextContent(t).length},p.lastNode=function(t){return t.childNodes[t.childNodes.length-1]},p.lastTextNode=function(t){return p.isTextNode(t)?t:p.lastTextNode(p.lastNode(t))},p.lastElement=function(t){return t.children[t.children.length-1]},p.firstNode=function(t){return t.childNodes[0]},p.firstTextNode=function(t){return p.isTextNode(t)?t:p.firstTextNode(p.firstNode(t))},p.firstElement=function(t){return t.children[0]},p.isLastElementOf=function(t,e){var n=p.lastElement(t);return n===e},p.isFirstElementOf=function(t,e){var n=p.firstElement(t);return n===e},p.mixin=function(t,e){return Object.getOwnPropertyNames(e).forEach(function(n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r)}),t},p.preventDefault=function(t){return t.preventDefault?t.preventDefault():t.returnValue=!1},p.os=function(){var t=navigator.userAgent;switch(!0){case/mac/i.test(t):return"mac";case/win/i.test(t):return"windows";case/linux/i.test(t):return"linux";default:return"unknown"}},p.each=function(t,e){return p.isArrayLike(t)&&Array.prototype.forEach.call(t,e),t},p.isArrayLike=function(t){return"object"==typeof t&&"number"==typeof t.length},p.split=function(t,e){var n=new RegExp("\\\\"+e,"g");return t.replace(n,"￿").split(e).map(function(t){return t.replace(/\uffff/g,e)})},p.clone=function(t){return JSON.parse(JSON.stringify(t))},p.equal=function(t,e){if(null===t||/^[sbn]/.test(typeof t))return t===e;if(t instanceof Array)return e instanceof Array?(t=t.slice().sort(),e=e.slice().sort(),t.join()===e.join()):!1;if("object"==typeof t){if("object"!=typeof e)return!1;var n,r;for(n in t)if(t.hasOwnProperty(n)&&(r=t.hasOwnProperty(n)&&e.hasOwnProperty(n)&&!p.equal(t[n],e[n])))return!1;return!0}return!1},p.getType=function(t){var e=p.getElementSchema(t);return e?e.type:null},p.getElementSchema=function(t){return t&&w[t.tagName.toLowerCase()]||null};var l={};l.modifiers={224:"command",91:"command",93:"command",18:"alt",17:"ctrl",16:"shift"},l.map={8:"backspace",9:"tab",13:"enter",20:"capslock",27:"esc",32:"space",37:"left",38:"up",39:"right",40:"down"},l.super="mac"===p.os()?"command":"ctrl";var h=function(t){return function(e){this.super&&"a"===this.key.toLowerCase()?(this.prevent(),t.caret.selectAll(t.el)):e()}},f=function(){return function(t){var e="enter"===this.key&&this.section===this.editor.caret.focusSection()&&!this.shift&&p.isTag("p",this.element)&&this.element.parentElement&&this.editor.caret.atElementEnd(this.element);if(e){this.prevent();var n=document.createElement("p");this.element.parentElement.insertBefore(n,this.element.nextSibling),this.editor.caret.focusTo(n)}t()}},d=function(t){var e=function(e){var n=document.getSelection(),r=e.paragraph;return!(n+"")&&p.isType(["paragraph","paragraphs","section"],r)&&t.caret.atElementStart(r)},n=function(e){var n=e.paragraph,r=e.paragraphs;if(r&&p.isFirstElementOf(r,n)){e.prevent();var i=document.createElement("p");p.moveChildNodes(n,i),p.removeElement(n),e.section.insertBefore(i,r),p.isEmpty(r)&&p.removeElement(r),t.caret.moveToStart(i)}},r=function(e){e.prevent();var n,r,i,a,o=e.paragraph,s=o.previousElementSibling;if(n=s?o:e.section,s=n.previousElementSibling,n&&s)if(p.isType("paragraphs",s)){if(s.lastChild&&p.isTag("li",s.lastChild)){var c=s.lastChild.lastChild;p.moveChildNodes(o,s.lastChild),p.removeElement(o),c?t.caret.moveToEnd(c):t.caret.moveToStart(s.lastChild)}}else i=n.firstChild,a=s.childNodes[s.childNodes.length-1],r=p.getTextContent(a).length,p.removeEmptyElements(s),p.moveChildNodes(n,s),n.parentElement.removeChild(n),p.isType("section",n)?t.caret.focusTo(i):a?t.caret.moveToStart(a,r):t.caret.moveToStart(s);else{s=e.node.previousSibling;var u=function(){return s&&p.isElementNode(s)&&p.isTag("br",s)};u()&&(r=p.getTextContent(s.previousSibling).length,s.parentElement.removeChild(s),t.caret.moveToStart(e.node.previousSibling,r))}},i=function(){var e=t.caret.focusParagraphs(),n=e&&e.nextElementSibling;return n&&n.tagName===e.tagName},a=function(){var e=t.caret.focusParagraphs(),n=e.nextElementSibling;p.moveChildNodes(n,e),p.removeElement(n)};return function(o){if("backspace"!==this.key)return o();var s=this.paragraph;if(e(this))p.isTag("li",s)?n(this,o):r(this,o);else if(this.figure){this.prevent();var c=this.figure.previousElementSibling;p.removeElement(this.figure),t.caret.moveToEnd(c)}i()&&a(),o()}},m=function(t){return function(e){var n=this.paragraph;if(!p.isTag("blockquote",n))return e();if("enter"!==this.key||this.shift)return e();if(t.caret.atElementEnd(n)){this.prevent();var r=document.createElement("p");r.innerHTML="<br />",this.section.insertBefore(r,n.nextSibling),t.caret.moveToStart(r)}else this.prevent(),t.caret.split(n);e()}},g=function(t){t.on("walk",function(t){var e=t.element;e.innerHTML.trim()||(p.isType("paragraph",e)?e.innerHTML='<br type="_med_placeholder" />':p.isType("section",e)&&(e.innerHTML='<p><br type="_med_placeholder" /></p>'))})},v=function(t){var e="is-active",n=function(n){var r=t.el.querySelector("figure.is-active");r&&r!==n&&r.classList.remove(e)};return t.on("walkEnd",function(){var r=t.caret.focusFigure();r&&r.classList.add(e),n(r)}),t.el.addEventListener("mousedown",function(r){var i=r.target;for(p.isAncestorOf(t.caret.focusNode(),t.el)||t.caret.moveToStart(i);;){if(!i||i===t.el){i=null;break}if(p.isTag("figure",i))break;i=i.parentElement}i&&i.classList.add(e),n(i)}),t.el.addEventListener("blur",function(){n()}),function(t){t()}},y=function(t){var e=function(e){e.prevent();var n=e.paragraph,r=document.createElement("p");r.innerHTML="<br />",p.isLastElementOf(e.paragraphs,n)?(e.section.insertBefore(r,e.paragraphs.nextSibling),p.removeElement(n)):(p.removeElement(n),t.caret.split(e.paragraphs),e.section.insertBefore(r,e.paragraphs)),t.caret.moveToStart(r)},n=function(e){var n=e.paragraph,r=document.createElement("p");r.innerHTML=n.innerHTML,p.removeElement(n),e.section.insertBefore(r,e.paragraphs.nextSibling),t.caret.moveToStart(r)};return function(r){var i=this.paragraph;return p.isTag("li",i)?("enter"!==this.key||this.shift||(p.isEmpty(i)?e(this):t.caret.atElementEnd(i)?(this.prevent(),t.caret.split(i)):t.caret.atElementStart(i)&&p.isLastElementOf(this.paragraphs,i)&&(this.prevent(),n(this))),void r()):r()}},E=function(){var t=function(t){return!t.modifier&&p.isTag("p",t.paragraph)&&e(t)},e=function(t){return"enter"===t.key&&!t.shift},n=function(t,e){var n=t.editor,r=t.paragraph;if(p.isEmpty(r)){t.prevent();var i=t.section;if(i){if(p.isNotEmpty(i)){var a;p.removeEmptyElements(i),n.caret.split(i),a=document.createElement("p"),a.innerHTML="<br />",i.insertBefore(a,i.firstChild),n.caret.moveToStart(a),e()}}else i=document.createElement("section"),i.appendChild(r),n.el.appendChild(i),n.caret.moveToStart(r),e()}else n.caret.atElementStart(r)&&(t.prevent(),n.caret.split(t.section),p.removeEmptyElements(t.section),p.isNotEmpty(t.section.previousElementSibling)&&p.removeEmptyElements(t.section.previousElementSibling),e())};return function(){return function(e){return t(this)?void n(this,e):e()}}}(),T=function(){return function(t){var e=this.event,n=e.keyCode||e.which,r=l.modifiers[n],i=this.editor;this.modifier=r,this.ctrl=e.ctrlKey,this.option=this.alt=e.altKey,this.shift=e.shiftKey,this.command=this.meta=e.metaKey,this.code=n,this.key=l.map[n]||String.fromCharCode(n),this.super=this[l.super],this.node=i.caret.focusNode(),this.element=i.caret.focusElement(),this.nextElement=i.caret.nextElement(),this.section=i.caret.focusSection(),this.paragraph=i.caret.focusParagraph(),this.paragraphs=i.caret.focusParagraphs(),this.figure=i.el.querySelector("figure.is-active"),this.detail=i.caret.focusDetail();var a=i.el.querySelectorAll('br[type="_med_placeholder"]');Array.prototype.forEach.call(a,function(t){p.removeElement(t)}),t()}},x=function(){return function(t){var e=this.element;return"backspace"===this.key&&this.editor.isEmpty()?void this.prevent():~[document.body,this.section].indexOf(e)?void this.prevent():void t()}},b=function(t){t.on("walkEnd",function(t){var e=t.focusTo,n=t.focusOffset;e&&t.editor.caret.select(e,n,e,n)})},N=function(t){var e=function(t){for(var e,n,r,i=t.element,a=t.editor.caret.focusElement(),o=i.childNodes,s=o.length,c=function(){return n&&n.nodeType===e.nodeType&&p.isAllowedToHaveContent(n)};s--;)e=o[s],n=o[s-1],c()&&(n===a&&(r=p.lastNode(a),t.focusTo=r,t.focusOffset=r.length),p.isTextNode(n)?n.appendData(e.data):p.isElementNode(n)&&p.moveChildNodes(e,n),e.parentNode.removeChild(e))};t.on("walk",function(t){p.isType("paragraph",t.element)&&e(t)})},S=function(t){t.on("walk",function(t){t.el.setAttribute("style","")})},C=function(t){t.on("walkStart",function(t){t.names={}}),t.on("walk",function(t){t.names[t.name]?t.el.setAttribute("name",""):t.names[t.name]=1})},w={section:{type:"section"},h1:{type:"paragraph",text:"content"},h2:{type:"paragraph",text:"content"},h3:{type:"paragraph",text:"content"},h4:{type:"paragraph",text:"content"},h5:{type:"paragraph",text:"content"},h6:{type:"paragraph",text:"content"},p:{type:"paragraph",text:"content"},blockquote:{type:"paragraph",text:"content",quoteTpye:"dataset:type"},figure:{type:"figure"},ol:{type:"paragraphs"},ul:{type:"paragraphs"},li:{type:"paragraph",text:"content"},a:{type:"detail",href:"attribute",title:"attribute"},b:{type:"detail"},i:{type:"detail"},br:{type:"detail"}};Object.keys(w).forEach(function(t){var e=w[t],n=e.type,r=[];delete e.type,Object.keys(e).forEach(function(t){var n=e[t],i=n.split(":"),a=i.shift();r.push({name:i[0]||t,type:a,args:i})}),w[t]={type:n,attrs:r}}),e.prototype.on=function(t,e){var n=this.events[t]||[];return n.push(e),this.events[t]=n,this},e.prototype.once=function(t,e){return e._once=!0,this.on(t,e),this},e.prototype.off=function(t,e){if("function"==typeof t){e=t;for(t in this.events)this.events.hasOwnProperty(t)&&this.off(t,e);return this}for(var n=this.events[t],r=n.length;r--;)e===n[r]&&n.splice(r,1);return this},e.prototype.emit=function(){var t,e=Array.prototype.slice.call(arguments),n=e.shift(),r=this.events[n]||[],i=r.length;if("error"===n&&!i)throw e[0];for(;i--;)t=r[i],t.apply(this,e),t._once&&r.splice(i,1);return this},n.prototype.focusNode=function(){return document.getSelection().focusNode},n.prototype.focusElement=function(t){var e;if(t){for(e=this.focusElement(),t=t.toUpperCase();e&&e.tagName!==t;)e=e.parentElement;return e&&e.tagName===t?e:null}for(e=document.getSelection().focusNode;e&&!p.isElementNode(e);)e=e.parentNode;return e},n.prototype.focusSection=function(){return this.focusType("section")},n.prototype.focusParagraph=function(){return this.focusType("paragraph")},n.prototype.focusParagraphs=function(){return this.focusType("paragraphs")},n.prototype.focusFigure=function(){return this.focusType("figure")},n.prototype.focusDetail=function(){return this.focusType("detail")},n.prototype.focusType=function(t){for(var e,n=this.focusElement();;){if(!n)break;if(e=p.getType(n),e===t)return n;n=n.parentElement}return null},n.prototype.nextElement=function(t){for(t?t=t.nextSibling:(t=this.focusNode(),t=t&&t.nextSibling);t;){if(p.isElementNode(t))return t;t=t.nextSibling}return null},n.prototype.focusTo=function(t){t&&(t.innerHTML.trim()?this.moveToStart(t):(t.innerHTML="￿",this.moveToStart(t),t.innerHTML=""))},n.prototype.textBefore=function(){var t=document.getSelection(),e=t.focusNode,n=t.focusOffset;return p.isElementNode(e)?"":e.substringData(0,n)},n.prototype.textAfter=function(){var t=document.getSelection(),e=t.focusNode,n=t.focusOffset;return p.isElementNode(e)?"":e.substringData(n,e.length-1)},n.prototype.moveToStart=function(t,e){if(t){var n,r=document.getSelection(),i=document.createRange();n=p.isTextNode(t)?p.getTextContent(t).length:t.childNodes.length,e=0|e,0>e?e=0:e>=n&&(e=n),i.setStart(t,e),i.setEnd(t,e),r.removeAllRanges(),r.addRange(i),r.collapseToStart()}},n.prototype.moveToEnd=function(e,n){if(e){var r,i=document.createRange(),a=t.getSelection();r=p.isTextNode(e)?p.getTextContent(e).length:e.childNodes.length,n=r-(0|n),0>n&&(n=0),i.setStart(e,n),i.setEnd(e,n),a.removeAllRanges(),a.addRange(i),a.collapseToEnd()}},n.prototype.split=function(t){if(!t)return null;var e=document.getSelection(),n=e.focusNode,r=e.focusOffset,i=document.createRange(),a=Array.prototype.indexOf.call(t.parentNode.childNodes,t);i.setStart(t.parentNode,a),i.setEnd(n,r);var o=i.extractContents();return t.parentNode.insertBefore(o,t),t},n.prototype.save=function(){var t,e=document.getSelection();e&&(e.rangeCount&&(t=e.getRangeAt(0)),this._range=t)},n.prototype.restore=function(){var t=this._range;if(t){var e=document.createRange(),n=document.getSelection();e.setStart(t.startContainer,t.startOffset),e.setEnd(t.endContainer,t.endOffset),n.removeAllRanges(),n.addRange(e)}},n.prototype.selectAllText=function(e){var n=t.getSelection(),r=document.createRange();r.selectNodeContents(e),n.removeAllRanges(),n.addRange(r)},n.prototype.selectAll=function(t){var e=p.firstNode(t),n=p.lastNode(t);editor.caret.select(e,n)},n.prototype.select=function(){var e,n,r,i,a,o=t.getSelection(),s=function(){p.isEmpty(e)&&p.setNodeContent(e,"￿"),p.isEmpty(r)&&p.setNodeContent(r,"￿")},c=function(){var t=p.getTextContent(e),n=p.getTextContent(r),i=/\uffff/g;t=t.replace(i,""),n=n.replace(i,""),p.setNodeContent(e,t),p.setNodeContent(r,n)};switch(arguments.length){case 1:e=r=arguments[0],n=0,i=p.getTextContent(e).length;break;case 2:"number"==typeof arguments[1]?(e=r=arguments[0],n=i=arguments[1],s()):(e=arguments[0],n=0,r=arguments[1],s(),i=p.getTextContent(r).length);break;case 3:e=arguments[0],r=arguments[1],s(),n=0,i=p.getTextContent(e).length;break;case 4:e=arguments[0],n=arguments[1],r=arguments[2],i=arguments[3],s()}n=0|n,i=0|i,a=document.createRange(),a.setStart(e,n),a.setEnd(r,i),o.removeAllRanges(),o.addRange(a),c()},n.prototype.insertElement=function(t){var e=document.getSelection(),n=e.getRangeAt(0);n.deleteContents(),n.insertNode(t)},n.prototype.closestElement=function(){var t=this.focusNode();return this.nextElement(t)},n.prototype.atElementStart=function(t){if(!t.childNodes.length)return!0;var e=document.getSelection(),n=e.focusNode,r=e.focusOffset,i=document.createRange();return i.setStart(t.childNodes[0],0),i.setEnd(n,r),!i.toString().trim()},n.prototype.atElementEnd=function(t){if(!t.childNodes.length)return!0;var e=document.getSelection(),n=e.focusNode,r=e.focusOffset,i=document.createRange(),a=p.lastTextNode(t);return i.setStart(n,r),i.setEnd(a,a.length),!i.toString().trim()},r.prototype.use=function(t){if("function"!=typeof t)throw new Error("The first argument must me a function.");return this.middleware.push(t),this},r.prototype.exec=function(t,e){var n=this.compose(this.middleware);n.call(t,e)},r.prototype.compose=function(t){return function(e){var n=0,r=function(i){if(i)return e(i);var a=t[n++];if(!a)return e();try{a.call(this,r)}catch(o){e(o)}}.bind(this);r()}},i.prototype.set=function(t,e){return p.equal(this.get(t),e)||(this.modified=!0),this.tmp[t]=e,this},i.prototype._set=function(t,e){for(var n=p.split(t,"."),r=n.pop(),i=this.data;t=n.shift();)i=void 0===i[t]?i[t]={}:i[t];return i[r]=e,this},i.prototype.get=function(t){if(this.tmp[t])return this.tmp[t];for(var e=p.split(t,"."),n=this.data;t=e.shift();){if(void 0===n)return;n=n[t]}return n},i.prototype.update=function(){var t=this.tmp;return Object.keys(t).forEach(function(e){this._set(e,t[e])}.bind(this)),this.modified=!1,this.tmp={},this},i.prototype.toJSON=function(){return p.clone(this.data)},a.prototype.sync=function(){var t={paragraphs:[],sections:[]},e=this.data,n={},r={structure:t,shouldBeDelete:n};Object.keys(e).forEach(function(t){n[t]=1}),p.each(this.el.children,function(t){a.scan.call(this,r,t)}.bind(this)),Object.keys(n).forEach(function(t){delete e[t]}),this.structure=t},a.scan=function(t,e){var n=e.tagName.toLowerCase(),r=e.getAttribute("name"),o=this.data[r],s=this.schema[n];return s?(a.checkAndRemoveStrangeElement.call(this,e),r&&delete t.shouldBeDelete[r],o||(r||(r=this.options.genName()),o=new i(r),o.set("tag",n),this.data[r]=o,e.setAttribute("name",o.id)),a[s.type].call(this,t,e,o),s.attrs.forEach(function(t){a[t.type].call(this,e,o,t)}.bind(this)),o.modified&&(o.update(),this.emit("changed",o)),o):void e.parentElement.removeChild(e)},a.section=function(t,e,n){var r=t.structure,i=[];p.each(e.children,function(e){var o=p.getElementSchema(e);return o?(~r.sections.indexOf(n.id)||r.sections.push(n.id),void(/^(paragraphs?|figure)$/.test(o.type)&&i.push(a.scan.call(this,t,e).id))):void a.handleUnknownElement(e)}.bind(this)),n.set("start",r.paragraphs.length),n.set("end",Array.prototype.push.apply(r.paragraphs,i))},a.paragraphs=function(t,e,n){var r=t.structure,i=[];p.each(e.children,function(e){var n=p.getElementSchema(e);return n?void("paragraph"===n.type&&i.push(a.scan.call(this,t,e).id)):void a.handleUnknownElement(e)}.bind(this)),n.set("start",r.paragraphs.length),n.set("end",Array.prototype.push.apply(r.paragraphs,i))},a.figure=function(t,e,n){var r=this.getFigureType(e);r.updateData(e,n)},a.paragraph=function(t,e,n){var r=[];p.each(e.children,function(e){var n=p.getElementSchema(e);return n?void("detail"===n.type&&r.push(a.scan.call(this,t,e).id)):void a.handleUnknownElement(e)}.bind(this)),n.set("detail",r)},a.detail=function(t,e,n){var r=a.getOffset(e);n.set("start",r.start),n.set("end",r.end)},a.attribute=function(t,e,n){var r=t.getAttribute(n.name);e.set(n.name,r)},a.dataset=function(t,e,n){var r=t.getAttribute("data-"+n.name);e.set(n.name,r)},a.content=function(t,e,n){var r=p.getTextContent(t);e.set(n.name,r)},a.handleUnknownElement=function(t){var e=p.getTextContent(t),n=document.createTextNode(e);t.parentElement.replaceChild(n,t)},a.getOffset=function(t){for(var e,n,r,i=t.parentNode,a={start:0,end:0},o=function(){return i&&p.isElementNode(i)&&!i.getAttribute("name")};o();)i=i.parentElement;return i&&(r=document.createElement("div"),a.start=i.innerHTML.indexOf(t.outerHTML),e=i.innerHTML.substr(0,a.start),r.innerHTML=e,n=p.getTextContent(r),a.start-=e.length-n.length,a.end=a.start+p.getTextContent(t).length),a},a.prototype.toJSON=function(){function t(t){var e=i[t],n=e&&e.toJSON()||{};return n.name=t,n}this.structure||this.sync();var e=this.structure,n=e.sections,r=e.paragraphs,i=this.data,a={sections:[],paragraphs:[]};return n.forEach(function(t){var e=i[t],n=e&&e.toJSON()||{};n.name=t,a.sections.push(n)}),r.forEach(function(e){var n=i[e],r=n&&n.toJSON()||{};r.name=e,r.detail=(r.detail||[]).map(t),a.paragraphs.push(r)}),a},a.rules={section:{paragraph:1,paragraphs:1,figure:1},paragraphs:{paragraph:1},paragraph:{detail:1},detail:{}},a.checkAndRemoveStrangeElement=function(t){var e=p.getType(t),n=p.getType(t.parentElement),r=!0;e&&n?a.rules[n][e]&&(r=!1):t.parentElement===this.el&&"section"===e&&(r=!1),r&&t.parentElement.removeChild(t)},o.prototype.registerFigureType=function(t,e){var n=new s(t,e);return this.figureTypes[t]=n,this},o.prototype.getFigureType=function(t){return p.isElementNode(t)&&(t=t.getAttribute("type")),this.figureTypes[t]||this.figureTypes.default},s.prototype.updateData=function(t,e){e.set("figureType",this.name),this.options.updateData&&this.options.updateData(t,e)},s.prototype.updateHTML=function(t,e){t.setAttribute("type",this.name),this.options.updateHTML&&this.options.updateHTML(t,e)},c.prototype.fromJSON=function(t){c.importData.call(this,t),c.buildHTML.call(this)},c.importData=function(t){function e(t){var e=t.name,r=n[e]=new i(e);return delete t.name,r.data=t,r.update(),e}t=p.clone(t);var n=this.data={},r=this.structure={},a=r.sections=[],o=r.paragraphs=[];return(t.sections||[]).forEach(function(t){var e=t.name,r=n[e]=new i(e);delete t.name,r.data=t,r.update(),a.push(e)}),(t.paragraphs||[]).forEach(function(t){var r=t.name,a=n[r]=new i(r);delete t.name,a.data=t,"figure"!==a.get("type")&&(t.detail=(t.detail||[]).map(e)),a.update(),o.push(r)}),this},c.buildHTML=function(){var t=document.createDocumentFragment(),e=this.el,n="";c.createElements.call(this,t),p.each(t.childNodes,function(t){n+=t.outerHTML}),e.innerHTML=n},c.createElements=function(t){c.createSections.call(this,t)},c.createSections=function(t){var e=this.structure,n=this.data;e.sections.forEach(function(e){var r=n[e],i=c.createElement(r);c.createParagraphs.call(this,r,i),t.appendChild(i)}.bind(this))},c.createParagraphs=function(t,e){var n=this.structure,r=this.data;n.paragraphs.slice(t.get("start"),t.get("end")).forEach(function(t){var n=r[t],i=c.createElement(n),a=p.getType(i);"paragraphs"===a?c.createParagraphs.call(this,n,i):n.get("in-paragraphs")||(p.isType("figure",i)?c.createFigure.call(this,n,i):c.createDetails.call(this,n,i)),e.appendChild(i)}.bind(this))},c.createFigure=function(t,e){var n=this.getFigureType(t.get("type"));n.updateHTML(e,t)},c.createDetails=function(t,e){var n,r,i=this.data,a=t.get("detail"),o=t.get("text"),s=0;e.innerHTML="",a.forEach(function(t){var a=i[t],u=c.createElement(a),p=a.get("start"),l=a.get("end");s!==p&&(n=o.slice(s,p),r=document.createTextNode(n),e.appendChild(r)),u.innerHTML=o.slice(p,l),e.appendChild(u),s=l}),s!==o.length&&(n=o.slice(s,o.length),r=document.createTextNode(n),e.appendChild(r))},c.createElement=function(t){var e=t.get("tag"),n=document.createElement(e);return n.setAttribute("name",t.id),c.initElement(n,t),n},c.initElement=function(t,e){var n=w[e.get("tag")];n.attrs.forEach(function(n){c[n.type](t,e,n)})},c.attribute=function(t,e,n){t.setAttribute(n.name,e.get(n.name))},c.dataset=function(t,e,n){t.setAttribute("data-"+n.name,e.get(n.name))},c.content=function(t,e,n){void 0===t.textContent?t.innerText=e.get(n.name):t.textContent=e.get(n.name)};var O={genName:function(){var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx";return t.replace(/[xy]/g,function(t){var e=16*Math.random()|0,n="x"===t?e:3&e|8;return n.toString(16)})}};u.prototype=Object.create(e.prototype),p.mixin(u.prototype,r.prototype),p.mixin(u.prototype,a.prototype),p.mixin(u.prototype,c.prototype),p.mixin(u.prototype,o.prototype),u.prototype.start=function(){return N(this),C(this),S(this),g(this),b(this),this.compose([x(),h(this),E(this),y(this),v(this),m(this),d(this)])},u.prototype.end=function(){return this.compose([f()])},u.prototype.schema=w,u.prototype.bindEvents=function(){var t=this.el,e=t.addEventListener.bind(t);e("keydown",this.onKeydown.bind(this)),e("keyup",this.handleEmpty.bind(this)),e("blur",this.handleEmpty.bind(this)),e("focus",this.handleEmpty.bind(this))},u.prototype.onKeydown=function(t){var e;this.handleEmpty(),e=Object.create(this.context),e.event=t,e.prevent=p.preventDefault.bind(null,t),this.exec(e,function(t){t&&this.emit("error",t)}.bind(this)),this.sync(),this.walk()},u.prototype.isEmpty=function(){var t=this.el.children,e=t[0];return t.length<=1&&!p.getTextContent(e).trim()},u.prototype.handleEmpty=function(){var t=this.el.children[0];if(!t){var e=document.createElement("p");t=document.createElement("section"),e.innerHTML='<br type="_med_placeholder">',t.appendChild(e),this.el.appendChild(t),this.sync(this.el),setTimeout(function(){this.caret.focusTo(e)}.bind(this))}this.isEmpty()?this.el.classList.add("is-empty"):this.el.classList.remove("is-empty")},u.prototype.walk=function(){var t=this.el.querySelectorAll("[name]"),e={editor:this};e.editor=this,this.emit("walkStart",e),Array.prototype.forEach.call(t,function(t){e.el=t,e.element=t,e.name=t.getAttribute("name"),e.data=this.data[e.name],this.emit("walk",e)}.bind(this)),this.emit("walkEnd",e)}}(this);
//# sourceMappingURL=./dist/med.map