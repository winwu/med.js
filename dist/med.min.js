!function(t){"use strict";function e(){this.events={}}function n(t){this.editor=t}function r(){this.middleware=[]}function i(t){this.id=t,this.modified=!1,this.data={},this.tmp={}}function a(){this.structure=null,this.data={}}function o(){}function s(t){e.call(this),r.call(this),a.call(this),o.call(this),this.options=c.mixin(Object.create(l),t),this.context={},this.context.editor=this;var i=this.options.el;i||(i=document.createElement("div")),i.setAttribute("contenteditable",!0),i.classList.add("med"),this.el=i,this.caret=new n(this),this.bindEvents(),this.handleEmpty(),this.use(h.init()),this.use(h.basic(this))}"undefined"!=typeof module?module.exports=s:"function"==typeof define&&"object"==typeof define.amd?define(function(){return s}):t.Med=s;var c={};c.mixin=function(t,e){return Object.getOwnPropertyNames(e).forEach(function(n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r)}),t},c.preventEvent=function(t){return t.preventDefault?t.preventDefault():t.returnValue=!1},c.os=function(){var t=navigator.userAgent;switch(!0){case/mac/i.test(t):return"mac";case/win/i.test(t):return"windows";case/linux/i.test(t):return"linux";default:return"unknown"}},c.each=function(t,e){return"object"==typeof t&&"number"==typeof t.length&&Array.prototype.forEach.call(t,e),t},c.split=function(t,e){var n=new RegExp("\\\\"+e,"g");return t.replace(n,"￿").split(e).map(function(t){return t.replace(/\uffff/g,e)})},c.clone=function(t){if(null===t||"object"!=typeof t)return t;if(t instanceof Date){var e=new Date;return e.setTime(t.getTime()),e}if(t instanceof Array)return t.slice();var e={};for(var n in t)t.hasOwnProperty(n)&&(e[n]=c.clone(t[n]));return e};var p={};p.modifiers={224:"command",91:"command",93:"command",18:"alt",17:"ctrl",16:"shift"},p.map={8:"backspace",9:"tab",13:"enter",20:"capslock",27:"esc",32:"space",37:"left",38:"up",39:"right",40:"down"},p.super="mac"===c.os()?"command":"ctrl";var h={};h.init=function(){return function(t){var e=this.event,n=e.keyCode||e.which,r=p.modifiers[n];if(!r){if(this.ctrl=e.ctrlKey,this.option=this.alt=e.altKey,this.shift=e.shiftKey,this.command=this.meta=e.metaKey,this.code=n,this.key=p.map[n],this.super=this[p.super],this.event=e,"backspace"===this.key&&this.editor.isEmpty())return void this.prevent();var i=editor.el.querySelectorAll('br[type="_med_placeholder"]');Array.prototype.forEach.call(i,function(t){t.parentElement.removeChild(t)}),t()}}},h.basic=function(t){return function(e){var n=t.caret.focusElement();if("SECTION"===n.tagName)return this.prevent();if("enter"===this.key&&!this.shift){if("P"!==n.tagName)return e();if(this.prevent(),(n.textContent||n.innerText||"").trim()){if(t.caret.textBefore(n).trim()){var r=t.caret.split(n);r.setAttribute("name",""),r.textContent||r.innerText||(r.innerHTML='<br type="_med_placeholder">')}else if(n.previousElementSibling){var i=document.createElement("section"),a=t.caret.focusElement("section"),r=t.caret.split(n);n=r.previousElementSibling,r.setAttribute("name",""),i.appendChild(r),r.textContent||r.innerText||(r.innerHTML='<br type="_med_placeholder">'),a?a.parentElement.insertBefore(i,a.nextSibling):t.el.appendChild(i),(n.textContent||n.innerText||"").trim()||n.parentElement.removeChild(n),t.caret.moveToStart(r)}}else{var i=document.createElement("section"),a=t.caret.focusElement("section");n.innerHTML='<br type="_med_placeholder">',a?(a.textContent||a.innerText||"").trim()&&(i.appendChild(n),a.parentElement.insertBefore(i,a.nextSibling),t.caret.moveToStart(n)):(i.appendChild(n),t.el.appendChild(i),t.caret.moveToStart(n))}}e()}};var u={section:{type:"section"},h1:{type:"paragraph",text:"content"},h2:{type:"paragraph",text:"content"},h3:{type:"paragraph",text:"content"},h4:{type:"paragraph",text:"content"},h5:{type:"paragraph",text:"content"},h6:{type:"paragraph",text:"content"},p:{type:"paragraph",text:"content"},blockquote:{type:"paragraph",text:"content",quoteTpye:"dataset:type"},figure:{type:"paragraph",figureType:"dataset:type",content:"dataset:content"},ol:{type:"paragraphs"},ul:{type:"paragraphs"},li:{type:"paragraph",text:"content"},a:{type:"detail",href:"attribute",title:"attribute"},b:{type:"detail"},i:{type:"detail"},br:{type:"detail"}};Object.keys(u).forEach(function(t){var e=u[t],n=e.type,r=[];delete e.type,Object.keys(e).forEach(function(t){var n=e[t],i=n.split(":"),a=i.shift();r.push({name:i[0]||t,type:a,args:i})}),u[t]={type:n,attrs:r}}),e.prototype.on=function(t,e){var n=this.events[t]||[];return n.push(e),this.events[t]=n,this},e.prototype.once=function(t,e){return e._once=!0,this.on(t,e),this},e.prototype.off=function(t,e){if("function"==typeof t){e=t;for(t in this.events)this.off(t,e);return this}for(var n=this.events[t],r=n.length;r-=1;)e===n[r]&&n.split(r,1);return this},e.prototype.emit=function(){var t=Array.prototype.slice.call(arguments),e=t.shift(),n=this.events[e]||[];return n.forEach(function(e){e.apply(this,t)}.bind(this)),this},n.prototype.focusElement=function(t){var e;if(t){for(e=this.focusElement(),t=t.toUpperCase();e&&e.tagName!==t;)e=e.parentElement;return e.tagName===t?e:null}return document.getSelection?(e=document.getSelection().focusNode,e.nodeType===document.ELEMENT_NODE?e:e.parentElement):document.selection.createRange().parentElement()},n.prototype.focusTo=function(t){t.innerHTML.trim()?this.moveToStart(t):(t.innerHTML="￿",this.moveToStart(t),t.innerHTML="")},n.prototype.textBefore=function(){var t=document.getSelection(),e=t.focusNode,n=t.focusOffset;return e.nodeType===document.ELEMENT_NODE?"":e.substringData(0,n)},n.prototype.textAfter=function(){var t=document.getSelection(),e=t.focusNode,n=t.focusOffset;return e.nodeType===document.ELEMENT_NODE?"":e.substringData(n,e.length-1)},n.prototype.moveToStart=function(t){if(document.getSelection)t.focus(),document.getSelection().collapse(t,!0);else{var e=document.body.createTextRange();e.moveToElementText(t),e.collapse(!0),e.select()}},n.prototype.moveToEnd=function(e){if(document.getSelection){var n=document.createRange(),r=t.getSelection();n.selectNodeContents(e),n.collapse(!1),r.removeAllRanges(),r.addRange(n)}else{e.focus();var i=document.body.createTextRange();i.moveToElementText(e),i.collapse(!1),i.select()}},n.prototype.split=function(t){var e=document.getSelection(),n=e.focusNode,r=e.focusOffset,i=document.createRange(),a=Array.prototype.indexOf.call(t.parentNode.childNodes,t);i.setStart(t.parentNode,a),i.setEnd(n,r);var o=i.extractContents();return t.parentNode.insertBefore(o,t),t},r.prototype.use=function(t){if("function"!=typeof t)throw new Error("The first argument must me a function.");return this.middleware.push(t),this},r.prototype.exec=function(t,e){var n=this.middleware,r=0,i=function(a){if(a)return e(a);var o=n[r++];if(!o)return e();try{o.call(t,i)}catch(s){e(s)}};i()},i.prototype.set=function(t,e){return this.tmp[t]=e,this.modified=!0,this},i.prototype._set=function(t,e){for(var n=c.split(t,"."),r=n.pop(),i=this.data;t=n.shift();)i=void 0===i[t]?i[t]={}:i[t];return i[r]!==e&&(this.modified=!0,i[r]=e),this},i.prototype.get=function(t){if(this.tmp[t])return this.tmp[t];for(var e=c.split(t,".");t=e.shift();){if(void 0===data)return;data=data[t]}return data},i.prototype.update=function(){var t=this.tmp;return Object.keys(t).forEach(function(e){this._set(e,t[e])}.bind(this)),this.modified=!1,this.tmp={},this},i.prototype.toJSON=function(){return c.clone(this.data)},a.prototype.sync=function(){var t={paragraphs:[],sections:[]},e=this.data,n={};Object.keys(e).forEach(function(t){n[t]=1}),this._scan(this.el,t,n),Object.keys(n).forEach(function(t){delete e[t]}),this.structure=t},a.prototype._scan=function(t,e,n){var r=t.tagName.toLowerCase(),o=t.getAttribute("name"),s=this.data[o],p=this.schema[r];return p?(o&&delete n[o],s||(o||(o=this.options.genName()),s=new i(o),s.set("tag",r),this.data[o]=s,t.setAttribute("name",s.id)),a[p.type].call(this,t,s,e,n),p.attrs.forEach(function(e){a[e.type].call(this,t,s,e)}.bind(this)),s.modified&&(s.update(),this.emit("changed",s)),s):void c.each(t.children,function(t){this._scan(t,e,n)}.bind(this))},a.section=function(t,e,n,r){var i=[];c.each(t.children,function(t){var a=this.schema[t.tagName.toLowerCase()];~n.sections.indexOf(e.id)||n.sections.push(e.id),/^paragraph/.test(a.type)&&i.push(this._scan(t,n,r).id)}.bind(this)),e.set("start",n.paragraphs.length),e.set("end",Array.prototype.push.apply(n.paragraphs,i))},a.paragraphs=function(t,e,n,r){var i=[];c.each(t.children,function(t){var a=this.schema[t.tagName.toLowerCase()];n.sections.push(e.id),"paragraph"===a.type&&i.push(this._scan(t,n,r).id)}.bind(this)),e.set("start",n.paragraphs.length),e.set("end",Array.prototype.push.apply(n.paragraphs,i))},a.paragraph=function(t,e,n,r){var i=[];c.each(t.children,function(t){var a=this.schema[t.tagName.toLowerCase()];n.sections.push(e.id),"detail"===a.type&&i.push(this._scan(t,n,r).id)}.bind(this)),e.set("detail",i)},a.detail=function(t,e){var n=a.getOffset(t);e.set("start",n.start),e.set("end",n.end)},a.attribute=function(t,e,n){var r=t.getAttribute(n.name);e.set(n.name,r)},a.dataset=function(t,e,n){var r=t.getAttribute("data-"+n.name);e.set(n.name,r)},a.content=function(t,e,n){var r=t.textContent||t.innerText;e.set(n.name,r)},a.getOffset=function(t){for(var e,n,r,i=t.parentNode,a={start:0,end:0},o=function(){return i&&i.nodeType===document.ELEMENT_NODE&&!i.getAttribute("name")};o();)i=i.parentElement;return i&&(r=document.createElement("div"),a.start=i.innerHTML.indexOf(t.outerHTML),e=i.innerHTML.substr(0,a.start),r.innerHTML=e,n=r.textContent||r.innerText||"",a.start-=e.length-n.length,a.end=a.start+(t.textContent||t.innerText||"").length),a},a.prototype.toJSON=function(){function t(t){var e=i[t],n=e&&e.toJSON()||{};return n.name=t,n}var e=this.structure,n=e.sections,r=e.paragraphs,i=this.data,a={sections:[],paragraphs:[]};return n.forEach(function(t){var e=i[t],n=e&&e.toJSON()||{};n.name=t,a.sections.push(n)}),r.forEach(function(e){var n=i[e],r=n&&n.toJSON()||{};r.name=e,r.detail=(r.detail||[]).map(t),a.paragraphs.push(r)}),a},o.prototype.fromJSON=function(t){var e=this.el,n=t.sections,r=t.paragraphs;n.forEach(function(t,i){var i,a,s,c=e.querySelector('[name="'+t.name+'"]'),p=n[i-1],h=p&&e.querySelector('[name="'+p.name+'"]');for(c||(c=document.createElement(t.tag),c.setAttribute("name",t.name)),i=t.start;i<t.end;i+=1)a=r[i],s=c.querySelector('[name="'+a.name+'"]'),s||(s=document.createElement(a.tag),s.setAttribute("name",a.name)),o.initElement.call(this,s,a),o.createDetail.call(this,s,a),s.parentElement||c.appendChild(s);c.parentElement||(h?h.parentElement.insertBefore(c,h.nextSibling):this.el.appendChild(c))}.bind(this)),this.handleEmpty()},o.createDetail=function(t,e){var n=t.textContent||t.innerText,r=e.detail||[],i="",a=0;r.forEach(function(e){var r=t.querySelector('[name="'+e.name+'"]');r||(r=document.createElement(e.tag),r.setAttribute("name",e.name)),o.initElement.call(this,r,e),void 0===r.textContent?r.innerText=n.substr(e.start,e.end-e.start):r.textContent=n.substr(e.start,e.end-e.start),i+=n.substr(a,e.start-a)+r.outerHTML,a=e.end}.bind(this)),i+=n.substr(a,n.length-a),t.innerHTML=i},o.initElement=function(t,e){var n=this.schema[e.tag];n.attrs.forEach(function(n){o[n.type].call(this,t,e,n)})},o.attribute=function(t,e,n){t.setAttribute(n.name,e[n.name])},o.dataset=function(t,e,n){t.setAttribute("data-"+n.name,e[n.name])},o.content=function(t,e,n){void 0===t.textContent?t.innerText=e[n.name]:t.textContent=e[n.name]};var l={genName:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,n="x"===t?e:3&e|8;return n.toString(16)})}};s.prototype=Object.create(e.prototype),c.mixin(s.prototype,r.prototype),c.mixin(s.prototype,a.prototype),c.mixin(s.prototype,o.prototype),s.prototype.schema=u,s.prototype.bindEvents=function(){var t=this.el,e=t.addEventListener.bind(t);e("keydown",this.onKeydown.bind(this)),e("keyup",this.sync.bind(this)),e("keyup",this.handleEmpty.bind(this)),e("blur",this.handleEmpty.bind(this)),e("focus",this.handleEmpty.bind(this))},s.prototype.onKeydown=function(t){var e,n=this.caret.focusElement();return n===this.el||n===document.body?void c.preventEvent(t):(this.handleEmpty(),e=Object.create(this.context),e.event=t,e.prevent=c.preventEvent.bind(null,t),void this.exec(e,function(t){t&&this.emit("error",t)}.bind(this)))},s.prototype.isEmpty=function(){var t=this.el.children,e=t[0];return t.length<=1&&!(e.textContent||e.innerText||"").trim()},s.prototype.handleEmpty=function(){var t=this.el.children[0];if(!t){var e=document.createElement("p");t=document.createElement("section"),e.innerHTML='<br type="_med_placeholder">',t.appendChild(e),this.el.appendChild(t),this.sync(this.el),this.caret.focusTo(e)}this.isEmpty()?this.el.classList.add("is-empty"):this.el.classList.remove("is-empty")}}(this);
//# sourceMappingURL=./dist/med.map