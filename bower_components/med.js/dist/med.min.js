!function(t){"use strict";function n(){this.events={}}function r(t){this.editor=t}function a(){this.middleware=[]}function i(t){this.id=t,this.modified=!1,this.data={},this.tmp={}}function o(){this.structure=null,this.data={}}function s(){}function c(t){n.call(this),a.call(this),o.call(this),s.call(this),this.options=p.mixin(Object.create(d),t||{}),this.context={},this.context.editor=this;var e=this.options.el;e||(e=document.createElement("div")),e.setAttribute("contenteditable",!0),e.classList.add("med"),this.el=e,this.caret=new r(this),this.bindEvents(),this.handleEmpty(),this.use(h.init())}"undefined"!=typeof module?module.exports=c:"function"==typeof define&&"object"==typeof define.amd?define(function(){return c}):t.Med=c;var p={};p.mixin=function(t,e){return Object.getOwnPropertyNames(e).forEach(function(n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r)}),t},p.preventEvent=function(t){return t.preventDefault?t.preventDefault():t.returnValue=!1},p.os=function(){var t=navigator.userAgent;switch(!0){case/mac/i.test(t):return"mac";case/win/i.test(t):return"windows";case/linux/i.test(t):return"linux";default:return"unknown"}},p.each=function(t,e){return"object"==typeof t&&"number"==typeof t.length&&Array.prototype.forEach.call(t,e),t},p.split=function(t,e){var n=new RegExp("\\\\"+e,"g");return t.replace(n,"￿").split(e).map(function(t){return t.replace(/\uffff/g,e)})},p.clone=function(t){return JSON.parse(JSON.stringify(t))},p.equal=function(t,e){if(null===t||/^[sbn]/.test(typeof t))return t===e;if(t instanceof Array)return e instanceof Array?(t=t.slice().sort(),e=e.slice().sort(),t.join()===e.join()):!1;if("object"==typeof t){if("object"==typeof e){var n;for(n in t)if(t.hasOwnProperty(n)&&e.hasOwnProperty(n)&&!p.equal(t[n],e[n]))return!1;return!0}return!1}return!1};var u={};u.modifiers={224:"command",91:"command",93:"command",18:"alt",17:"ctrl",16:"shift"},u.map={8:"backspace",9:"tab",13:"enter",20:"capslock",27:"esc",32:"space",37:"left",38:"up",39:"right",40:"down"},u.super="mac"===p.os()?"command":"ctrl";var h={};h.init=function(){return function(t){var e=this.event,n=e.keyCode||e.which,r=u.modifiers[n],a=this.editor;this.modifier=r,this.ctrl=e.ctrlKey,this.option=this.alt=e.altKey,this.shift=e.shiftKey,this.command=this.meta=e.metaKey,this.code=n,this.key=u.map[n],this.super=this[u.super],this.node=a.caret.focusNode(),this.element=a.caret.focusElement(),this.nextElement=a.caret.nextElement(),this.section=a.caret.focusSection(),this.paragraph=a.caret.focusParagraph(),this.paragraphs=a.caret.focusParagraphs(),this.detail=a.caret.focusDetail();var i=a.el.querySelectorAll('br[type="_med_placeholder"]');Array.prototype.forEach.call(i,function(t){t.parentElement.removeChild(t)}),t()}},h.prevent=function(){return function(t){return"backspace"===this.key&&this.editor.isEmpty()?void this.prevent():this.element===document.body?void p.preventEvent(e):void t()}},h.p=function(t){return function(e){var n=this.element;if(this.modifier)return e();if(n===n.section)return this.prevent();if("P"!==n.tagName)return e();if("enter"===this.key&&!this.shift&&!(n.textContent||n.innerText||"").trim()){this.prevent();var r=document.createElement("section"),a=t.caret.focusElement("section");a?(a.textContent||a.innerText||"").trim()&&(r.appendChild(n),a.parentElement.insertBefore(r,a.nextSibling),t.caret.moveToStart(n)):(r.appendChild(n),t.el.appendChild(r),t.caret.moveToStart(n))}e()}},h.renameElements=function(t){t.on("walkStart",function(t){t.names={}}),t.on("walk",function(t){t.names[t.name]?t.el.setAttribute("name",""):t.names[t.name]=1})},h.removeInlineStyle=function(){editor.on("walk",function(t){t.el.setAttribute("style","")})},h.removeExtraNodes=function(){var t=function(t){for(var e,n,r=t.children,a=r.length;a--;)e=r[a],n=r[a-1],n&&n.nodeType===e.nodeType&&(n.nodeType===document.TEXT_NODE?n.appendData(e.data):n.nodeType===document.ELEMENT_NODE&&(n.innerHTML+=e.textContent||e.innerHTML||""),e.parentNode.removeChild(e))};editor.on("walk",function(e){var n=l[e.el.tagName.toLowerCase()];"paragraph"===n.type&&t(e.el)})},h.handleEmptyParagraph=function(t){t.on("walk",function(t){var e=t.el;"P"!==e.tagName||(e.textContent||e.innerText||"").trim()||(e.innerHTML='<br class="_med_placeholder" />')})},h.createNewParagraph=function(){return function(t){var e="enter"===this.key&&this.section===this.editor.caret.focusSection()&&!this.shift&&this.element===this.paragraph&&!this.editor.caret.textAfter(this.element);if(e){this.prevent();var n=document.createElement("p");this.element.parentElement.insertBefore(n,this.element.nextSibling),this.editor.caret.focusTo(n)}t()}};var l={section:{type:"section"},h1:{type:"paragraph",text:"content"},h2:{type:"paragraph",text:"content"},h3:{type:"paragraph",text:"content"},h4:{type:"paragraph",text:"content"},h5:{type:"paragraph",text:"content"},h6:{type:"paragraph",text:"content"},p:{type:"paragraph",text:"content"},blockquote:{type:"paragraph",text:"content",quoteTpye:"dataset:type"},figure:{type:"paragraph",figureType:"dataset:type",content:"dataset:content"},ol:{type:"paragraphs"},ul:{type:"paragraphs"},li:{type:"paragraph",text:"content"},a:{type:"detail",href:"attribute",title:"attribute"},b:{type:"detail"},i:{type:"detail"},br:{type:"detail"}};Object.keys(l).forEach(function(t){var e=l[t],n=e.type,r=[];delete e.type,Object.keys(e).forEach(function(t){var n=e[t],a=n.split(":"),i=a.shift();r.push({name:a[0]||t,type:i,args:a})}),l[t]={type:n,attrs:r}}),n.prototype.on=function(t,e){var n=this.events[t]||[];return n.push(e),this.events[t]=n,this},n.prototype.once=function(t,e){return e._once=!0,this.on(t,e),this},n.prototype.off=function(t,e){if("function"==typeof t){e=t;for(t in this.events)this.off(t,e);return this}for(var n=this.events[t],r=n.length;r--;)e===n[r]&&n.splice(r,1);return this},n.prototype.emit=function(){for(var t,e=Array.prototype.slice.call(arguments),n=e.shift(),r=this.events[n]||[],a=r.length;a--;)t=r[a],t.apply(this,e),t._once&&r.splice(a,1);return this},r.prototype.focusNode=function(){return document.getSelection().focusNode},r.prototype.focusElement=function(t){var e;if(t){for(e=this.focusElement(),t=t.toUpperCase();e&&e.tagName!==t;)e=e.parentElement;return e&&e.tagName===t?e:null}for(e=document.getSelection().focusNode;e&&e.nodeType!==document.ELEMENT_NODE;)e=e.parentNode;return e},r.prototype.focusSection=function(){return this.focusType("section")},r.prototype.focusParagraph=function(){return this.focusType("paragraph")},r.prototype.focusParagraphs=function(){return this.focusType("paragraphs")},r.prototype.focusDetail=function(){return this.focusType("detail")},r.prototype.focusType=function(t){for(var e,n=this.focusElement();;){if(!n)break;if(e=n&&l[n.tagName.toLowerCase()],e&&e.type===t)return n;n=n.parentElement}return null},r.prototype.nextElement=function(t){for(t=t?t.nextSibling:this.focusNode().nextSibling;t;){if(t.nodeType===document.ELEMENT_NODE)return t;t=t.nextSibling}return null},r.prototype.focusTo=function(t){t.innerHTML.trim()?this.moveToStart(t):(t.innerHTML="￿",this.moveToStart(t),t.innerHTML="")},r.prototype.textBefore=function(){var t=document.getSelection(),e=t.focusNode,n=t.focusOffset;return e.nodeType===document.ELEMENT_NODE?"":e.substringData(0,n)},r.prototype.textAfter=function(){var t=document.getSelection(),e=t.focusNode,n=t.focusOffset;return e.nodeType===document.ELEMENT_NODE?"":e.substringData(n,e.length-1)},r.prototype.moveToStart=function(t){t.focus(),document.getSelection().collapse(t,!0)},r.prototype.moveToEnd=function(e){var n=document.createRange(),r=t.getSelection();n.selectNodeContents(e),n.collapse(!1),r.removeAllRanges(),r.addRange(n)},r.prototype.split=function(t){var e=document.getSelection(),n=e.focusNode,r=e.focusOffset,a=document.createRange(),i=Array.prototype.indexOf.call(t.parentNode.childNodes,t);a.setStart(t.parentNode,i),a.setEnd(n,r);var o=a.extractContents();return t.parentNode.insertBefore(o,t),t},r.prototype.save=function(){var t,e=document.getSelection();e&&(e.rangeCount&&(t=e.getRangeAt(0)),this._range=t)},r.prototype.restore=function(){var t=this._range;if(t){var e=document.createRange(),n=document.getSelection();e.setStart(t.startContainer,t.startOffset),e.setEnd(t.endContainer,t.endOffset),n.removeAllRanges(),n.addRange(e)}},r.prototype.selectAllText=function(e){var n=t.getSelection(),r=document.createRange();r.selectNodeContents(e),n.removeAllRanges(),n.addRange(r)},r.prototype.insertElement=function(t){var e=document.getSelection(),n=e.getRangeAt(0);n.deleteContents(),n.insertNode(t)},r.prototype.closestElement=function(){var t=this.focusNode();return this.nextElement(t)},a.prototype.use=function(t){if("function"!=typeof t)throw new Error("The first argument must me a function.");return this.middleware.push(t),this},a.prototype.exec=function(t,e){var n=this.compose(this.middleware);n.call(t,e)},a.prototype.compose=function(t){return function(e){var n=0,r=function(a){if(a)return e(a);var i=t[n++];if(!i)return e();try{i.call(this,r)}catch(o){e(o)}}.bind(this);r()}},i.prototype.set=function(t,e){return p.equal(this.get(t),e)||(this.modified=!0),this.tmp[t]=e,this},i.prototype._set=function(t,e){for(var n=p.split(t,"."),r=n.pop(),a=this.data;t=n.shift();)a=void 0===a[t]?a[t]={}:a[t];return a[r]=e,this},i.prototype.get=function(t){if(this.tmp[t])return this.tmp[t];for(var e=p.split(t,"."),n=this.data;t=e.shift();){if(void 0===n)return;n=n[t]}return n},i.prototype.update=function(){var t=this.tmp;return Object.keys(t).forEach(function(e){this._set(e,t[e])}.bind(this)),this.modified=!1,this.tmp={},this},i.prototype.toJSON=function(){return p.clone(this.data)},o.prototype.sync=function(){var t={paragraphs:[],sections:[]},e=this.data,n={};Object.keys(e).forEach(function(t){n[t]=1}),p.each(this.el.children,function(e){o.scan.call(this,e,t,n)}.bind(this)),Object.keys(n).forEach(function(t){delete e[t]}),this.structure=t},o.scan=function(t,e,n){var r=t.tagName.toLowerCase(),a=t.getAttribute("name"),s=this.data[a],c=this.schema[r];return c?(o.checkAndRemoveStrangeElement.call(this,t),a&&delete n[a],s||(a||(a=this.options.genName()),s=new i(a),s.set("tag",r),this.data[a]=s,t.setAttribute("name",s.id)),o[c.type].call(this,t,s,e,n),c.attrs.forEach(function(e){o[e.type].call(this,t,s,e)}.bind(this)),s.modified&&(s.update(),this.emit("changed",s)),s):void t.parentElement.removeChild(t)},o.section=function(t,e,n,r){var a=[];p.each(t.children,function(t){var i=this.schema[t.tagName.toLowerCase()];return i?(~n.sections.indexOf(e.id)||n.sections.push(e.id),void(/^paragraph/.test(i.type)&&a.push(o.scan.call(this,t,n,r).id))):void o.handleUnknownElement(t)}.bind(this)),e.set("start",n.paragraphs.length),e.set("end",Array.prototype.push.apply(n.paragraphs,a))},o.paragraphs=function(t,e,n,r){var a=[];p.each(t.children,function(t){var e=this.schema[t.tagName.toLowerCase()];return e?void("paragraph"===e.type&&a.push(o.scan.call(this,t,n,r).id)):void o.handleUnknownElement(t)}.bind(this)),e.set("start",n.paragraphs.length),e.set("end",Array.prototype.push.apply(n.paragraphs,a))},o.paragraph=function(t,e,n,r){var a=[];p.each(t.children,function(t){var e=this.schema[t.tagName.toLowerCase()];return e?void("detail"===e.type&&a.push(o.scan.call(this,t,n,r).id)):void o.handleUnknownElement(t)}.bind(this)),e.set("detail",a)},o.detail=function(t,e){var n=o.getOffset(t);e.set("start",n.start),e.set("end",n.end)},o.attribute=function(t,e,n){var r=t.getAttribute(n.name);e.set(n.name,r)},o.dataset=function(t,e,n){var r=t.getAttribute("data-"+n.name);e.set(n.name,r)},o.content=function(t,e,n){var r=t.textContent||t.innerText;e.set(n.name,r)},o.handleUnknownElement=function(t){var e=t.textContent||t.innerText,n=document.createTextNode(e);t.parentElement.replaceChild(n,t)},o.getOffset=function(t){for(var e,n,r,a=t.parentNode,i={start:0,end:0},o=function(){return a&&a.nodeType===document.ELEMENT_NODE&&!a.getAttribute("name")};o();)a=a.parentElement;return a&&(r=document.createElement("div"),i.start=a.innerHTML.indexOf(t.outerHTML),e=a.innerHTML.substr(0,i.start),r.innerHTML=e,n=r.textContent||r.innerText||"",i.start-=e.length-n.length,i.end=i.start+(t.textContent||t.innerText||"").length),i},o.prototype.toJSON=function(){function t(t){var e=a[t],n=e&&e.toJSON()||{};return n.name=t,n}var e=this.structure,n=e.sections,r=e.paragraphs,a=this.data,i={sections:[],paragraphs:[]};return n.forEach(function(t){var e=a[t],n=e&&e.toJSON()||{};n.name=t,i.sections.push(n)}),r.forEach(function(e){var n=a[e],r=n&&n.toJSON()||{};r.name=e,r.detail=(r.detail||[]).map(t),i.paragraphs.push(r)}),i},o.rules={section:{paragraph:1,paragraphs:1},paragraphs:{paragraph:1},paragraph:{detail:1},detail:{}},o.checkAndRemoveStrangeElement=function(t){var e=(l[t.tagName.toLowerCase()]||{}).type,n=(l[t.parentElement.tagName.toLowerCase()]||{}).type,r=!0;e&&n?o.rules[n][e]&&(r=!1):t.parentElement===this.el&&"section"===e&&(r=!1),r&&t.parentElement.removeChild(t)},s.prototype.fromJSON=function(t){s.importData.call(this,t),s.buildHTML.call(this)},s.importData=function(t){function e(t){var e=t.name,r=n[e]=new i(e);return delete t.name,r.data=t,r.update(),e}t=p.clone(t);var n=this.data={},r=this.structure={},a=r.sections=[],o=r.paragraphs=[];return(t.sections||[]).forEach(function(t){var e=t.name,r=n[e]=new i(e);delete t.name,r.data=t,r.update(),a.push(e)}),(t.paragraphs||[]).forEach(function(t){var r=t.name,a=n[r]=new i(r);delete t.name,a.data=t,t.detail=(t.detail||[]).map(e),a.update(),o.push(r)}),this},s.buildHTML=function(){var t=document.createDocumentFragment(),e=this.el,n="";s.createElements(t,this.structure,this.data),p.each(t.childNodes,function(t){n+=t.outerHTML}),e.innerHTML=n},s.createElements=function(t,e,n){s.createSections(t,e,n)},s.createSections=function(t,e,n){e.sections.forEach(function(r){var a=n[r],i=s.createElement(a);s.createParagraphs(a,i,e,n),t.appendChild(i)})},s.createParagraphs=function(t,e,n,r){n.paragraphs.slice(t.get("start"),t.get("end")).forEach(function(t){var a=r[t],i=s.createElement(a),o=l[a.get("tag")];"paragraphs"===o.type?s.createParagraphs(a,i,n,r):a.get("in-paragraphs")||s.createDetails(a,i,n,r),e.appendChild(i)})},s.createDetails=function(t,e,n,r){var a=t.get("detail"),i=t.get("text"),o=0;e.innerHTML="",a.forEach(function(t){var n=r[t],a=s.createElement(n),c=n.get("start"),p=n.get("end");o!==c&&e.appendChild(document.createTextNode(i.slice(o,c))),a.innerHTML=i.slice(c,p),e.appendChild(a),o=p}),o!==i.length&&e.appendChild(document.createTextNode(i.slice(o,i.length)))},s.createElement=function(t){var e=t.get("tag"),n=document.createElement(e);return n.setAttribute("name",t.id),s.initElement(n,t),n},s.initElement=function(t,e){var n=l[e.get("tag")];n.attrs.forEach(function(n){s[n.type].call(this,t,e,n)})},s.attribute=function(t,e,n){t.setAttribute(n.name,e.get(n.name))},s.dataset=function(t,e,n){t.setAttribute("data-"+n.name,e.get(n.name))},s.content=function(t,e,n){void 0===t.textContent?t.innerText=e.get(n.name):t.textContent=e.get(n.name)};var d={genName:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,n="x"===t?e:3&e|8;return n.toString(16)})}};c.prototype=Object.create(n.prototype),p.mixin(c.prototype,a.prototype),p.mixin(c.prototype,o.prototype),p.mixin(c.prototype,s.prototype),c.prototype.default=function(){return h.removeExtraNodes(this),h.renameElements(this),h.removeInlineStyle(this),h.handleEmptyParagraph(this),this.compose([h.prevent(),h.p(this),h.createNewParagraph()])},c.prototype.schema=l,c.prototype.bindEvents=function(){var t=this.el,e=t.addEventListener.bind(t);e("keydown",this.onKeydown.bind(this)),e("keyup",this.handleEmpty.bind(this)),e("blur",this.handleEmpty.bind(this)),e("focus",this.handleEmpty.bind(this))},c.prototype.onKeydown=function(t){var e;this.handleEmpty(),e=Object.create(this.context),e.event=t,e.prevent=p.preventEvent.bind(null,t),setTimeout(function(){this.sync(),this.walk()}.bind(this)),this.exec(e,function(t){t&&this.emit("error",t)}.bind(this))},c.prototype.isEmpty=function(){var t=this.el.children,e=t[0];return t.length<=1&&!(e.textContent||e.innerText||"").trim()},c.prototype.handleEmpty=function(){var t=this.el.children[0];if(!t){var e=document.createElement("p");t=document.createElement("section"),e.innerHTML='<br type="_med_placeholder">',t.appendChild(e),this.el.appendChild(t),this.sync(this.el),this.caret.focusTo(e)}this.isEmpty()?this.el.classList.add("is-empty"):this.el.classList.remove("is-empty")},c.prototype.walk=function(){var t=editor.el.querySelectorAll("[name]"),e={};this.emit("walkStart",e),Array.prototype.forEach.call(t,function(t){var n=Object.create(e);n.el=t,n.name=t.getAttribute("name"),n.data=this.data[n.name],this.emit("walk",n)}.bind(this)),this.emit("walkEnd",e)}}(this);
//# sourceMappingURL=./dist/med.map